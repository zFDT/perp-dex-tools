# 项目修改说明

## 1. 优化 `trading_bot.py`

- **提取 `_calculate_close_price` 方法**：为了避免重复计算 `close_price`，提取了一个私有方法 `_calculate_close_price`，用于计算平仓价格。这提高了代码的可读性和可维护性。

## 2. 优化 `helpers/logger.py`

- **改进 `log` 方法**：将 `log` 方法中的 `if-elif` 语句替换为字典映射，提高了代码的可读性和可维护性。
- **实现飞书推送功能**：
  - 添加了 `last_lark_notification_time` 和 `lark_notification_interval` 属性，用于记录上次发送飞书推送的时间和配置时间间隔。
  - 在 `log` 方法中，当日志级别为 "ERROR" 时，调用 `_send_lark_notification` 方法发送飞书推送。
  - `_send_lark_notification` 方法会检查距离上次发送飞书推送的时间是否超过 `lark_notification_interval`，如果超过，则发送飞书推送，并更新 `last_lark_notification_time`。
  - 用户可以通过设置环境变量 `LARK_NOTIFICATION_INTERVAL` 来配置时间间隔（默认为 60 分钟）。
- **美化飞书消息**：修改了 `_send_lark_message` 方法，使其发送富文本消息到飞书。富文本消息包含一个标题 "🚨 Trading Bot Error Alert" 和错误信息内容，并且会@所有人。

## 3. 优化 `runbot.py`

- **缓存交易所列表**：在 `parse_arguments` 方法中，缓存了 `ExchangeFactory.get_supported_exchanges()` 的结果，避免了重复调用，提高了性能。
